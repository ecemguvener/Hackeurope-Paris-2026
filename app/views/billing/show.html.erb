<div class="w-full max-w-4xl mx-auto py-10 px-4">
  <div class="text-center mb-10 animate-fade-in">
    <h1 class="text-4xl font-bold text-gray-900 mb-2">Billing & Usage</h1>
    <p class="text-gray-600">Monitor your plan, credits, and usage.</p>
  </div>

  <%# Stub mode banner %>
  <% if @stub_mode %>
    <div class="bg-amber-50 border border-amber-200 rounded-2xl p-6 mb-8 animate-fade-in-up">
      <div class="flex items-start gap-3">
        <span class="text-2xl">⚠️</span>
        <div>
          <h3 class="font-bold text-amber-800 mb-1">Stub Mode Active</h3>
          <p class="text-sm text-amber-700 mb-3">
            Paid.ai is not configured. All requests are allowed and usage is only logged.
            To enable real billing, add the following to your <code class="bg-amber-100 px-1.5 py-0.5 rounded text-xs font-mono">.env</code> file:
          </p>
          <div class="bg-amber-100/50 rounded-lg p-4 font-mono text-xs text-amber-900 space-y-1">
            <p>PAID_API_URL=https://api.paid.ai</p>
            <p>PAID_API_KEY=your_paid_api_key</p>
            <p>PAID_COMPANY_ID=your_company_id</p>
            <p>PAID_FAIL_OPEN=true</p>
          </div>
          <p class="text-sm text-amber-700 mt-3">
            Get your keys at <a href="https://app.paid.ai" target="_blank" class="font-medium underline hover:text-amber-900">app.paid.ai</a> →
            Agent Integration → API Keys.
          </p>
        </div>
      </div>
    </div>
  <% end %>

  <%# Plan status + credits row %>
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8 animate-fade-in-up delay-100">
    <div class="bg-white rounded-2xl shadow-md border border-gray-200 p-6 text-center hover-lift relative overflow-hidden">
      <div class="absolute top-0 left-0 right-0 h-1 bg-indigo-600"></div>
      <p class="text-sm text-gray-500 mb-1">Plan</p>
      <p class="text-xl font-bold text-gradient"><%= @summary[:plan] %></p>
    </div>
    <div class="bg-white rounded-2xl shadow-md border border-gray-200 p-6 text-center hover-lift relative overflow-hidden">
      <div class="absolute top-0 left-0 right-0 h-1 bg-emerald-600"></div>
      <p class="text-sm text-gray-500 mb-1">Credits Remaining</p>
      <p class="text-xl font-bold text-gradient">
        <%= @summary[:remaining].present? ? number_with_delimiter(@summary[:remaining]) : "Unlimited" %>
      </p>
    </div>
    <div class="bg-white rounded-2xl shadow-md border border-gray-200 p-6 text-center hover-lift relative overflow-hidden">
      <div class="absolute top-0 left-0 right-0 h-1 bg-amber-600"></div>
      <p class="text-sm text-gray-500 mb-1">Documents Processed</p>
      <p class="text-xl font-bold text-gradient"><%= @documents.count %></p>
    </div>
  </div>

  <%# Credit usage progress bar %>
  <% unless @stub_mode %>
    <div class="bg-white rounded-2xl shadow-md border border-gray-200 p-6 mb-8 animate-fade-in-up delay-200 relative overflow-hidden">
      <div class="absolute top-0 left-0 right-0 h-1 bg-indigo-600"></div>
      <h2 class="text-lg font-bold text-gray-900 mb-4">Credit Usage</h2>
      <% if @summary[:bundles].present? %>
        <% @summary[:bundles].each do |bundle| %>
          <%
            granted = bundle.dig("granted_amount") || bundle.dig("total") || 0
            used = bundle.dig("used_amount") || bundle.dig("used") || 0
            pct = granted > 0 ? [ (used.to_f / granted * 100).round, 100 ].min : 0
            bar_color = pct > 90 ? "bg-red-600" : pct > 70 ? "bg-amber-600" : "bg-emerald-600"
          %>
          <div class="mb-4 last:mb-0">
            <div class="flex justify-between text-sm mb-1">
              <span class="font-medium text-gray-700"><%= bundle["name"] || "Credit Bundle" %></span>
              <span class="text-gray-500"><%= number_with_delimiter(used) %> / <%= number_with_delimiter(granted) %></span>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
              <div class="h-3 rounded-full <%= bar_color %> transition-all duration-500" style="width: <%= pct %>%"></div>
            </div>
          </div>
        <% end %>
      <% else %>
        <p class="text-gray-500 text-sm">No credit bundles found for this account.</p>
      <% end %>
    </div>
  <% end %>

  <%# Entitlements / features table %>
  <% if !@stub_mode && @summary[:customer].present? %>
    <div class="bg-white rounded-2xl shadow-md border border-gray-200 p-6 mb-8 animate-fade-in-up delay-300 relative overflow-hidden">
      <div class="absolute top-0 left-0 right-0 h-1 bg-emerald-600"></div>
      <h2 class="text-lg font-bold text-gray-900 mb-4">Entitlements</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div class="flex items-center justify-between bg-gray-50 rounded-lg px-4 py-3">
          <span class="text-sm text-gray-600 font-medium">Text Extraction</span>
          <span class="text-sm font-semibold text-emerald-600">Included</span>
        </div>
        <div class="flex items-center justify-between bg-gray-50 rounded-lg px-4 py-3">
          <span class="text-sm text-gray-600 font-medium">AI Transformation</span>
          <span class="text-sm font-semibold text-emerald-600">Included</span>
        </div>
        <div class="flex items-center justify-between bg-gray-50 rounded-lg px-4 py-3">
          <span class="text-sm text-gray-600 font-medium">Text-to-Speech</span>
          <span class="text-sm font-semibold text-emerald-600">Included</span>
        </div>
        <div class="flex items-center justify-between bg-gray-50 rounded-lg px-4 py-3">
          <span class="text-sm text-gray-600 font-medium">Chrome Extension</span>
          <span class="text-sm font-semibold text-emerald-600">Included</span>
        </div>
      </div>
    </div>
  <% end %>

  <%# Recent documents %>
  <div class="bg-white rounded-2xl shadow-md border border-gray-200 p-6 animate-fade-in-up delay-400 relative overflow-hidden">
    <div class="absolute top-0 left-0 right-0 h-1 bg-amber-600"></div>
    <h2 class="text-lg font-bold text-gray-900 mb-4">Recent Documents</h2>
    <% if @documents.any? %>
      <div class="divide-y divide-gray-100">
        <% @documents.each do |document| %>
          <div class="flex items-center justify-between py-4">
            <div>
              <p class="font-medium text-gray-900">
                <%= document.file.attached? ? document.file.filename : "Document ##{document.id}" %>
              </p>
              <p class="text-sm text-gray-500">
                <%= document.created_at.strftime("%b %d, %Y at %l:%M %p") %>
                · <%= number_with_delimiter(document.extracted_text.to_s.length) %> chars
              </p>
            </div>
            <div class="flex items-center gap-3">
              <% if document.version_selected? && document.selected_style %>
                <span class="text-xs bg-green-100 text-green-700 font-medium px-2 py-1 rounded-full">
                  <%= document.selected_style[:title] %>
                </span>
              <% end %>
              <% if document.audio_url.present? %>
                <span class="text-xs bg-indigo-100 text-indigo-700 font-medium px-2 py-1 rounded-full">TTS</span>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="text-center py-8">
        <p class="text-gray-500 mb-4">No documents yet.</p>
        <%= link_to "Upload a Document", upload_path,
              class: "inline-block text-white font-semibold py-2 px-6 rounded-xl bg-indigo-700 hover:bg-indigo-600 shadow-lg transition-all" %>
      </div>
    <% end %>
  </div>
</div>
