<%
  card_colors = [
    { accent: "from-blue-500 to-indigo-500",   header_bg: "bg-blue-50",    header_text: "text-blue-900",   header_sub: "text-blue-600",   btn_ring: "focus:ring-blue-500",   btn_bg: "bg-blue-600 hover:bg-blue-500",   pick_ring: "focus:ring-blue-500" },
    { accent: "from-emerald-500 to-teal-500",  header_bg: "bg-emerald-50", header_text: "text-emerald-900",header_sub: "text-emerald-600",btn_ring: "focus:ring-emerald-500",btn_bg: "bg-emerald-600 hover:bg-emerald-500",pick_ring: "focus:ring-emerald-500" },
    { accent: "from-amber-500 to-orange-500",  header_bg: "bg-amber-50",   header_text: "text-amber-900",  header_sub: "text-amber-600",  btn_ring: "focus:ring-amber-500",  btn_bg: "bg-amber-600 hover:bg-amber-500",  pick_ring: "focus:ring-amber-500" },
    { accent: "from-purple-500 to-fuchsia-500",header_bg: "bg-purple-50",  header_text: "text-purple-900", header_sub: "text-purple-600", btn_ring: "focus:ring-purple-500", btn_bg: "bg-purple-600 hover:bg-purple-500",pick_ring: "focus:ring-purple-500" }
  ]
  delays = ["delay-100", "delay-200", "delay-300", "delay-400"]
%>

<div class="w-full max-w-6xl mx-auto py-8 px-4 sm:px-6">

  <%# ── Page header ─────────────────────────────────────────────── %>
  <div class="text-center mb-8 animate-fade-in">

    <%# Step indicator %>
    <nav aria-label="Upload progress steps" class="flex justify-center mb-6">
      <ol class="step-list">
        <li class="step-item step-done">
          <span class="step-num" aria-hidden="true">&#10003;</span>
          <span>Upload</span>
        </li>
        <div class="step-connector" aria-hidden="true"></div>
        <li class="step-item step-active" aria-current="step">
          <span class="step-num" aria-hidden="true">2</span>
          <span>Choose Version</span>
        </li>
        <div class="step-connector" aria-hidden="true"></div>
        <li class="step-item">
          <span class="step-num" aria-hidden="true">3</span>
          <span>Listen</span>
        </li>
      </ol>
    </nav>

    <h1 class="text-3xl font-bold text-stone-800 mb-2">Choose Your Version</h1>
    <p class="text-stone-500 max-w-md mx-auto leading-relaxed">
      Read each version and pick the one that feels easiest. There's no wrong answer.
    </p>

    <%# Accessibility mode selector %>
    <div class="mt-4 flex items-center justify-center gap-2" role="group" aria-label="Reading accessibility mode">
      <span class="text-xs font-medium text-stone-400 uppercase tracking-wide">Mode:</span>
      <%= button_to "Standard", profile_readability_path(mode: "standard"), method: :patch,
            form: { class: "inline" },
            class: "text-xs px-3 py-1.5 rounded-full border font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 #{dyslexia_strong_mode?(current_user) ? 'border-stone-200 text-stone-500 hover:bg-stone-50' : 'border-indigo-300 bg-indigo-50 text-indigo-700'}" %>
      <%= button_to "Strong", profile_readability_path(mode: "strong"), method: :patch,
            form: { class: "inline" },
            class: "text-xs px-3 py-1.5 rounded-full border font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 #{dyslexia_strong_mode?(current_user) ? 'border-indigo-300 bg-indigo-50 text-indigo-700' : 'border-stone-200 text-stone-500 hover:bg-stone-50'}" %>
    </div>

    <%# Agent recommendation badge %>
    <% if (recommended = @document.transformations&.dig("_meta", "recommended_style")).present? %>
      <% style = Document.style_for_key(recommended) %>
      <p class="mt-4 inline-block rounded-full bg-indigo-50 px-4 py-1.5 text-sm font-medium text-indigo-700 border border-indigo-200">
        &#10024; Recommended for you: <strong><%= style&.dig(:title) || recommended.to_s.humanize %></strong>
      </p>
    <% end %>
  </div>

  <%# ── Version cards ───────────────────────────────────────────── %>
  <% if @document.transformations_ready? %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10"
         data-controller="collapse">
      <% @document.transformation_versions.each_with_index do |version, index| %>
        <% colors = card_colors[index] %>
        <article class="bg-white rounded-2xl shadow-sm border border-stone-200 flex flex-col overflow-hidden hover-lift animate-fade-in-up <%= delays[index] %>"
                 data-controller="toggle"
                 data-collapse-target="card"
                 aria-label="<%= version[:title] %> — transformation version <%= index + 1 %>">

          <%# Accent bar %>
          <div class="h-1.5 bg-gradient-to-r <%= colors[:accent] %>" aria-hidden="true"></div>

          <%# Card header %>
          <div class="px-5 pt-5 pb-3 border-b border-stone-100 <%= colors[:header_bg] %>">
            <h2 class="text-lg font-bold <%= colors[:header_text] %>"><%= version[:title] %></h2>
            <p class="text-sm <%= colors[:header_sub] %> mt-0.5 leading-snug"><%= version[:description] %></p>
          </div>

          <%# Content preview %>
          <div class="px-5 py-4 flex-1 overflow-hidden">
            <%# Transformed content %>
            <div data-toggle-target="transformed"
                 class="prose prose-sm max-w-none reading-area <%= dyslexia_reading_classes(current_user) %> p-4">
              <%= dyslexia_reading_html(version[:content] || "Awaiting transformation…", current_user) %>
            </div>

            <%# Original content (hidden by default) %>
            <div data-toggle-target="original"
                 class="hidden prose prose-sm max-w-none bg-amber-50 rounded-xl p-4 text-stone-700 leading-relaxed">
              <%= simple_format(@document.original_content || @document.extracted_text || "No original content.") %>
            </div>
          </div>

          <%# Card actions %>
          <div class="px-5 pb-5 mt-auto space-y-2.5">
            <%# Toggle original button %>
            <button data-toggle-target="button"
                    data-action="toggle#toggle"
                    class="w-full text-sm text-stone-600 font-medium py-2 px-4 rounded-lg
                           border border-stone-200 hover:bg-stone-50 transition-colors
                           focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
              Show Original
            </button>

            <%# Pick this version %>
            <%= link_to collapsed_path(@document, version: index + 1),
                  class: "block w-full text-center text-sm text-white font-semibold py-2.5 px-4 rounded-lg #{colors[:btn_bg]} transition-colors focus:outline-none focus:ring-2 #{colors[:pick_ring]} focus:ring-offset-2",
                  data: { turbo_method: :post, action: "click->collapse#select" },
                  "aria-label": "Pick #{version[:title]} as my version" do %>
              Pick This Version
            <% end %>
          </div>
        </article>
      <% end %>
    </div>

  <%# ── Loading state (transformations not yet ready) ──────────── %>
  <% else %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
      <% Document::TRANSFORMATION_STYLES.each_with_index do |style, index| %>
        <% colors = card_colors[index] %>
        <div class="bg-white rounded-2xl shadow-sm border border-stone-200 flex flex-col overflow-hidden animate-fade-in-up <%= delays[index] %>"
             aria-busy="true"
             aria-label="<%= style[:title] %> — loading">
          <div class="h-1.5 bg-gradient-to-r <%= colors[:accent] %>" aria-hidden="true"></div>
          <div class="px-5 pt-5 pb-3 border-b border-stone-100 <%= colors[:header_bg] %>">
            <h2 class="text-lg font-bold <%= colors[:header_text] %>"><%= style[:title] %></h2>
            <p class="text-sm <%= colors[:header_sub] %> mt-0.5"><%= style[:description] %></p>
          </div>
          <div class="px-5 py-6 flex-1 flex items-center justify-center">
            <div class="text-center" role="status" aria-label="Processing transformation">
              <div class="inline-block animate-pulse space-y-2.5 w-full max-w-xs">
                <div class="h-3 bg-stone-200 rounded w-full"></div>
                <div class="h-3 bg-stone-200 rounded w-5/6"></div>
                <div class="h-3 bg-stone-200 rounded w-4/5"></div>
                <div class="h-3 bg-stone-200 rounded w-3/4"></div>
              </div>
              <p class="text-sm text-stone-400 mt-4">Processing…</p>
            </div>
          </div>
          <div class="px-5 pb-5 mt-auto">
            <button disabled
                    class="w-full text-sm text-stone-400 font-semibold py-2.5 px-4 rounded-lg bg-stone-100 cursor-not-allowed"
                    aria-disabled="true">
              Pick This Version
            </button>
          </div>
        </div>
      <% end %>
    </div>

    <%# Original content while transformations load %>
    <% if @document.original_content.present? || @document.extracted_text.present? %>
      <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-sm border border-stone-200 p-6">
        <h2 class="text-base font-bold text-stone-800 mb-3">Extracted Text</h2>
        <div class="prose prose-sm max-w-none text-stone-700 reading-area">
          <%= simple_format(@document.extracted_text || @document.original_content) %>
        </div>
      </div>
    <% end %>
  <% end %>

  <%# ── Footer link ─────────────────────────────────────────────── %>
  <div class="text-center mt-6">
    <%= link_to "Upload another document", upload_path,
          class: "text-sm text-indigo-600 font-medium hover:text-indigo-500 transition-colors" %>
  </div>
</div>
